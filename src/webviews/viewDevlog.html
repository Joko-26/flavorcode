<!doctype html>
<html lang="en" id="html">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Devlog</title>
    <link rel="stylesheet" href="${styleUri}" />
    <link rel="stylesheet" href="${codiconUri}" />
  </head>
  <body>
    <!-- setup -->
    <div id="not-setup" class="devlog-display-container" style="display: none">
      <p>Flavorcode not setup yet set it up in the window above :D</p>
    </div>

    <!-- Devlogs -->
    <div
      id="devlog-container"
      class="devlog-display-container"
      style="display: none"
    >
      <div class="devlog-display-entry-headline">
        <p>Devlog Headline</p>
        <p>Duration</p>
      </div>
      <div
        id="info-message"
        class="devlog-display-container"
        style="display: block"
      >
        <p>Fetching devlogs this may take a while...</p>
      </div>
    </div>

    <script>
      const vscode = acquireVsCodeApi();
      let Devlogs = [];

      function populateDevlog(devlogInfo) {
        const infoMessage = document.getElementById("info-message");
        if (infoMessage) {
          infoMessage.style = "display: none;";
        }

        const safeDevlogs = Array.isArray(devlogInfo) ? devlogInfo : [];
        const devlogs = safeDevlogs.map((devlog, index) => {
          const devlogHead = getHead(devlog.body);
          const duration = formatDuration(devlog.duration_seconds);
          return `</i><div class="devlog-display-entry" data-index="${index}"><p> ${trimHeadline(devlogHead.headline)}</p><p>${duration}</p></div>`;
        });
        document.getElementById("devlog-container").innerHTML =
          `<div class="devlog-display-entry-headline"><p>Devlog Headline</p><p>Duration</p></div>`;
        document.getElementById("devlog-container").innerHTML +=
          devlogs.join("");
        if (
          document.getElementById("devlog-container").innerHTML ===
          `<div class="devlog-display-entry-headline"><p>Devlog Headline</p><p>Duration</p></div>`
        ) {
          document.getElementById("devlog-container").innerHTML +=
            `<div class="devlog-display-container"><p>Nothing here :( What are you waiting for, start creatings</p></div>`;
        }

        // Add click listeners to devlog entries
        document.querySelectorAll(".devlog-display-entry").forEach((entry) => {
          entry.addEventListener("click", () => {
            openDevlog(entry.dataset.index);
          });
        });
      }

      function switchMode(mode) {
        if (mode === "devlogs") {
          document.getElementById("not-setup").style = "display: none;";
          document.getElementById("devlog-container").style = "display: block;";
        } else {
          document.getElementById("not-setup").style = "display: block;";
          document.getElementById("devlog-container").style = "display: none;";
        }
      }

      function formatDuration(value) {
        const secondsIn = value;
        if (secondsIn < 3600) {
          let minutesOut = Math.floor(secondsIn / 60);
          let secondsOut = secondsIn % 60;
          return `${minutesOut} min; ${secondsOut} sec`;
        } else {
          let hoursOut = Math.floor(secondsIn / 3600);
          let secondsInMin = secondsIn % 3600;
          let minutesOut = Math.floor(secondsInMin / 60);
          let secondsOut = secondsInMin % 60;
          return `${hoursOut} h; ${minutesOut} min; ${secondsOut} sec`;
        }
      }

      function trimHeadline(headline) {
        const normalized = headline.replace(/[#]+/g, " ");

        if (!normalized) {
          return "";
        }

        return normalized;
      }

      // >_< hehehehehe
      function getHead(body) {
        const lines = body.split(/\r?\n/).map((line) => line.trim());
        const nonEmpty = lines.filter((line) => line.length > 0);

        if (nonEmpty.length === 0) {
          return { headline: "", content: "" };
        }

        const [headline, ...rest] = nonEmpty;
        return { headline, content: rest.join(" ") };
      }

      function openDevlog(id) {
        vscode.postMessage({
          command: "open-devlog",
          value: Devlogs[id],
          scope: "local",
        });
      }

      function setTheme(theme) {
        document.getElementById("html").classList = theme
      }

      // listens for messages from the extentsion
      window.addEventListener("message", (event) => {
        const message = event.data;
        if (message.scope === "local") {
          switch (message.command) {
            case "devlog-info":
              switchMode("devlogs");
              Devlogs = message.value;
              populateDevlog(message.value);
              break;
            case "setup":
              switchMode(" ");
              break;
            case "set-theme": {
              setTheme(message.value);
              break;
            }
          }
        } else {
          switch (message.command) {
            case "set-theme": {
              setTheme(message.value);
              break;
            }
          }
        }
      });
    </script>
  </body>
</html>
